<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>dmto.me - Chat Anonima</title>
  <meta name="description" content="Chat completamente anonime senza identit√† - libert√† assoluta">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./style.css">

  <!-- Config -->
  <script src="./config.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="./firebase-config.js"></script>
</head>
<body>
  <div class="bg-grid"></div>
  
  <main class="shell" style="display: flex; align-items: center; justify-content: center;">
    <div class="card" style="text-align: center; max-width: 400px;">
      <div class="loading-content">
        <div class="loading-logo">
          <span class="loading-dot"></span>
          <span class="loading-text">dmto.me</span>
        </div>
        <p style="color: var(--text); margin-top: 20px;">Reindirizzamento in corso...</p>
      </div>
    </div>
  </main>

  <script>
    // Router per gestire link dmto.me/username
    // Supporta sia ?u=username che #username che pathname diretto
    
    function redirectToTempChat(username) {
      console.log('üîó Reindirizzamento a temp-chat con username:', username);
      
      if (!username || username.trim() === '') {
        // Username non valido, reindirizza alla home
        console.log('‚ö†Ô∏è Username non valido, reindirizzo alla home');
        window.location.href = '/';
        return;
      }
      
      // Reindirizza immediatamente alla chat temporanea
      const redirectUrl = `./temp-chat.html?user=${encodeURIComponent(username.trim())}`;
      console.log('‚úÖ Reindirizzamento a:', redirectUrl);
      window.location.replace(redirectUrl);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ user.html caricato');
      console.log('üìç Pathname:', window.location.pathname);
      console.log('üîç Search:', window.location.search);
      console.log('# Hash:', window.location.hash);
      
      let username = null;
      
      // Metodo 1: Parametro URL ?u=username (Vercel rewrite)
      const urlParams = new URLSearchParams(window.location.search);
      username = urlParams.get('u');
      console.log('üìã Parametro u=', username);
      
      // Metodo 2: Hash #username
      if (!username && window.location.hash) {
        username = window.location.hash.substring(1); // Rimuove il #
        console.log('üîó Hash username:', username);
      }
      
      // Metodo 3: Pathname diretto (per routing diretto)
      // Es: /username -> username oppure /app/user.html?u=username
      if (!username) {
        const pathParts = window.location.pathname.split('/').filter(p => p);
        console.log('üìÇ Path parts:', pathParts);
        
        // Rimuovi parti note della path
        const filteredPath = pathParts.filter(p => 
          p !== 'app' && 
          p !== 'user' && 
          p !== 'user.html' &&
          !p.includes('.html') &&
          p !== 'favicon.ico' &&
          p !== 'robots.txt'
        );
        
        console.log('üîç Filtered path:', filteredPath);
        
        // L'ultimo segmento rimanente dovrebbe essere lo username
        if (filteredPath.length > 0) {
          username = filteredPath[filteredPath.length - 1];
          console.log('‚úÖ Username estratto dal pathname:', username);
        }
      }
      
      if (!username) {
        console.error('‚ùå Nessun username trovato!');
        // Mostra messaggio di errore all'utente
        document.querySelector('.loading-content').innerHTML = `
          <div style="color: var(--text);">
            <p style="color: #ff6b6b; margin-bottom: 16px;">‚ùå Link non valido</p>
            <p style="font-size: 14px; color: var(--muted);">Il link del profilo non √® corretto.</p>
            <button onclick="window.location.href='/'" style="margin-top: 20px; padding: 12px 24px; background: var(--accent); color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              Vai alla Home
            </button>
          </div>
        `;
        return;
      }
      
      // Reindirizza
      redirectToTempChat(username);
    });
  </script>
</body>
</html>
